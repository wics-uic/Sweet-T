---
// const {name = "User",order="This is a default order", date="Mon, Jan 1 â€¢ 11:59pm",due="Due today", status="Ready for Pickup"} = Astro.props;
// const { orders } = Astro.props;
const { id, name, order, date, due, status } = Astro.props;
// import CustomOrder from "./CustomOrder.astro";
console.log("DUE RECEIVED:", due);
---

<div class="flex flex-col gap-6 rounded-xl border border-[#e5e5e5] p-4 hover:shadow-md transition-shadow cursor-pointer" data-slot="card" >
    <div class="flex items-start justify-between gap-4">
        <!-- left-side/order details and checkmark -->
        <div class="flex-1 min-w-0">
            <!-- order details -->
            <div class="flex items-start justify-between gap-2 mb-1">
                <h3 class="truncate">{name}</h3>
                <!-- Checkmark Button -->
                <button 
                    class="complete-order-btn p-1 hover:bg-green-50 rounded-full transition-colors" 
                    data-order-id={id}
                    title="Mark as Complete"
                    aria-label="Mark order as complete"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-check h-6 w-6 text-[#044A25] flex-shrink-0" aria-hidden="true">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="m9 12 2 2 4-4"></path>
                    </svg>
                </button>
            </div>     
            <p class="text-gray-600 text-sm mb-3">{order}</p>
            <div class="flex flex-wrap items-center gap-2">
                <span class="text-sm">{date}</span>
                {due == "Due tomorrow" || due == "Due today" ? <span data-slot="badge" class="inline-flex items-center justify-center rounded-md border px-2 py-0.5 font-medium w-fit gap-1 bg-rose-100 text-rose-800 border-rose-200 text-xs">{due}</span> : <div></div>}
            </div>
        </div>
        <!-- ready for pickup part -->
        <div class="flex items-center gap-2 flex-shrink-0">
            {()=> {
                if (status == "Ready for Pickup") {
                    return(<span data-slot="badge" class="inline-flex items-center justify-center rounded-md border px-2 py-0.5 font-medium w-fit gap-1 bg-[#044A25] text-white border-[#044A25] text-xs">{status}</span>)
                } 
                else if (status == "Pending"){
                    return(<span data-slot="badge" class="inline-flex items-center justify-center rounded-md border px-2 py-0.5 font-medium w-fit bg-amber-100 text-amber-800 border-amber-200 text-xs">{status}</span>)
                }
                else {
                    return(<span data-slot="badge" class="inline-flex items-center justify-center rounded-md border px-2 py-0.5 font-medium w-fit bg-gray-100 text-gray-600 border-gray-200 text-xs">{status}</span>)
                }
            }}
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right h-5 w-5 text-gray-400" aria-hidden="true">
                <path d="m9 18 6-6-6-6"></path>
            </svg>
        </div>
    </div>
</div>

<script>
    const API_URL = "http://localhost:8000/api/orders/completeOrder";

    // Use event delegation or attach to all buttons
    // Since this component is repeated, the script runs once per component instance if inline, 
    // or we can use a global listener. 
    // Astro scripts with no attributes run once per page load if bundled, but here it's inside the component.
    // Better to attach listeners to all buttons found on the page.

    document.addEventListener('DOMContentLoaded', () => {
        const buttons = document.querySelectorAll('.complete-order-btn');
        
        buttons.forEach(btn => {
            // Remove existing listeners to avoid duplicates if any re-renders happen (unlikely in static Astro)
            // But good practice.
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.addEventListener('click', async (e) => {
                e.stopPropagation(); // Prevent card click
                e.preventDefault();

                const orderId = newBtn.getAttribute('data-order-id');
                if (!orderId) return;

                if (!confirm("Are you sure you want to mark this order as complete?")) {
                    return;
                }

                try {
                    const response = await fetch(API_URL, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ orderId }),
                        credentials: "include"
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        alert("Order marked as complete!");
                        // Reload to update UI
                        window.location.reload();
                    } else {
                        alert("Failed to complete order: " + (result.message || "Unknown error"));
                    }
                } catch (error) {
                    console.error("Error completing order:", error);
                    alert("Error completing order. Check console.");
                }
            });
        });
    });
</script>
